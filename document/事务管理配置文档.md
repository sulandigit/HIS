# 事务管理配置文档

## 概述
本文档说明HIS系统的事务管理配置，包括超时设置和回滚策略。

## 配置文件

### 1. TransactionConfig.java
位置: `HIS-api/src/main/java/com/neu/his/config/TransactionConfig.java`

**功能:**
- 配置全局事务管理器
- 设置默认事务超时时间为30秒
- 启用全局回滚策略

**配置项:**
```java
// 默认超时时间
transactionManager.setDefaultTimeout(30);

// 全局回滚策略
transactionManager.setGlobalRollbackOnParticipationFailure(true);
```

### 2. application.yml
位置: `HIS-api/src/main/resources/application.yml`

**新增配置:**
```yaml
spring:
  transaction:
    default-timeout: 30  # 默认事务超时时间(秒)
    rollback-on-commit-failure: true  # 提交失败时回滚
```

## 事务注解使用

### 基本用法
在Service实现类的方法上添加 `@Transactional` 注解:

```java
@Transactional(timeout = 30, rollbackFor = Exception.class)
public int charge(List<BmsChargeParam> bmsChargeParamList) {
    // 业务逻辑
}
```

### 注解参数说明

#### timeout (超时时间)
- **单位**: 秒
- **默认值**: 30秒
- **建议设置**:
  - 简单查询操作: 10-20秒
  - 常规业务操作: 20-30秒
  - 复杂业务操作: 30-60秒
  - 批量数据处理: 60-120秒

#### rollbackFor (回滚异常类型)
- **推荐配置**: `rollbackFor = Exception.class`
- **作用**: 遇到任何异常都回滚事务
- **原因**: 确保数据一致性，避免脏数据

### 已优化的方法

#### BmsFeeServiceImpl
1. **charge()** - 收费
   - 超时: 30秒
   - 回滚策略: 所有异常

2. **refundCharge()** - 退费
   - 超时: 30秒
   - 回滚策略: 所有异常

3. **refundRegistrationCharge()** - 挂号退费
   - 超时: 20秒
   - 回滚策略: 所有异常

#### DmsDrugStoreServiceImpl
1. **releaseDrug()** - 发药
   - 超时: 20秒
   - 回滚策略: 所有异常

2. **refundDrug()** - 退药
   - 超时: 30秒
   - 回滚策略: 所有异常

#### DmsRegistrationServiceImpl
1. **createRegistration()** - 创建挂号
   - 超时: 30秒
   - 回滚策略: 所有异常

2. **appRegistration()** - APP挂号
   - 超时: 30秒
   - 回滚策略: 所有异常

## 事务切面

### TransactionAspect
位置: `HIS-api/src/main/java/com/neu/his/config/TransactionAspect.java`

**功能:**
- 自动记录事务开始、提交、回滚日志
- 监控事务执行时间
- 对超过5秒的事务发出警告
- 统一异常处理和回滚

**日志示例:**
```
INFO  - 事务开始 - 方法: BmsFeeServiceImpl.charge(..)
INFO  - 事务提交成功 - 方法: BmsFeeServiceImpl.charge(..), 耗时: 1234ms
WARN  - 事务执行时间过长 - 方法: BmsFeeServiceImpl.charge(..), 耗时: 5678ms，建议优化
ERROR - 事务执行失败，准备回滚 - 方法: BmsFeeServiceImpl.charge(..), 耗时: 2345ms, 异常: ...
```

## 异常处理

### 自定义异常

#### BusinessException (业务异常)
位置: `HIS-common/src/main/java/com/neu/his/exception/BusinessException.java`

**用途**: 业务逻辑验证失败时抛出
**示例**:
```java
if (amount <= 0) {
    throw new BusinessException("BIZ001", "金额必须大于0");
}
```

#### DatabaseException (数据库异常)
位置: `HIS-common/src/main/java/com/neu/his/exception/DatabaseException.java`

**用途**: 数据库操作失败时抛出
**示例**:
```java
try {
    mapper.insert(record);
} catch (Exception e) {
    throw new DatabaseException("数据库插入失败", e);
}
```

### 全局异常处理器
位置: `HIS-api/src/main/java/com/neu/his/config/GlobalExceptionHandler.java`

**功能:**
- 统一处理各类异常
- 自动触发事务回滚
- 返回标准化错误响应
- 记录详细异常日志

## 回滚策略

### 默认策略
所有带 `@Transactional` 注解的方法都配置了 `rollbackFor = Exception.class`，确保:
1. 任何运行时异常都触发回滚
2. 任何检查型异常也触发回滚
3. 保证数据一致性

### 自动回滚场景
1. **业务异常**: 抛出 BusinessException
2. **数据库异常**: 抛出 DatabaseException 或 DataAccessException
3. **事务超时**: 超过配置的timeout时间
4. **其他异常**: 任何未捕获的Exception

### 手动回滚
如果需要手动标记事务回滚:
```java
TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
```

## 性能优化建议

### 1. 合理设置超时时间
- 根据实际业务复杂度调整timeout
- 避免设置过长导致资源占用
- 避免设置过短导致正常业务中断

### 2. 减少事务范围
- 只在需要的地方使用@Transactional
- 避免在事务中执行耗时的非数据库操作
- 将查询操作移到事务外

### 3. 批量操作优化
- 对于大批量数据，考虑分批处理
- 使用批量插入/更新减少数据库交互
- 适当增加批量操作的超时时间

### 4. 监控和告警
- 关注事务执行时间日志
- 对超过5秒的事务进行优化
- 定期检查事务回滚日志

## 常见问题

### Q1: 事务没有回滚？
**可能原因:**
1. 没有添加 `@Transactional` 注解
2. 异常被捕获没有抛出
3. 使用了不正确的rollbackFor配置

**解决方案:**
- 确保方法上有 `@Transactional` 注解
- 使用 `rollbackFor = Exception.class`
- 不要捕获异常，或捕获后重新抛出

### Q2: 事务超时如何处理？
**处理方式:**
1. 检查业务逻辑是否可以优化
2. 适当增加timeout配置
3. 考虑将大事务拆分为小事务

### Q3: 如何调试事务问题？
**调试方法:**
1. 查看TransactionAspect的日志输出
2. 检查GlobalExceptionHandler的异常记录
3. 开启SQL日志查看执行语句
4. 使用数据库监控工具查看锁等待

## 测试建议

### 单元测试
```java
@Test
@Transactional
@Rollback(true)  // 测试后自动回滚
public void testCharge() {
    // 测试代码
}
```

### 集成测试
1. 测试正常提交场景
2. 测试异常回滚场景
3. 测试超时回滚场景
4. 测试并发事务场景

## 更新日志

### 2025-11-03
- 添加全局事务配置
- 设置默认超时时间30秒
- 优化回滚策略为所有异常都回滚
- 添加事务切面监控
- 添加全局异常处理
- 为关键Service方法添加事务注解
