# HISç³»ç»Ÿå¤šçº§ç¼“å­˜ç­–ç•¥å®ç°æ€»ç»“

## ä¸€ã€å®ç°çš„åŠŸèƒ½æ¨¡å—

### 1. æ ¸å¿ƒç»„ä»¶ (6ä¸ªæ ¸å¿ƒç±»)

| ç»„ä»¶ | è·¯å¾„ | åŠŸèƒ½è¯´æ˜ |
|------|------|---------|
| `CacheLevel` | cache/CacheLevel.java | ç¼“å­˜çº§åˆ«æšä¸¾(L1/L2/L1+L2) |
| `CacheKey` | cache/CacheKey.java | ç¼“å­˜é”®å°è£…,æ”¯æŒå‘½åç©ºé—´ |
| `MultiLevelCacheManager` | cache/MultiLevelCacheManager.java | å¤šçº§ç¼“å­˜ç®¡ç†å™¨,æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ |
| `CaffeineCacheConfig` | cache/config/CaffeineCacheConfig.java | Caffeineç¼“å­˜é…ç½® |
| `CaffeineCacheProperties` | cache/config/CaffeineCacheProperties.java | ç¼“å­˜é…ç½®å±æ€§ |
| `CacheStatistics` | cache/stats/CacheStatistics.java | ç¼“å­˜ç»Ÿè®¡ç›‘æ§å·¥å…· |

### 2. æ³¨è§£å’Œåˆ‡é¢ (3ä¸ªç±»)

| ç»„ä»¶ | è·¯å¾„ | åŠŸèƒ½è¯´æ˜ |
|------|------|---------|
| `@MultiLevelCache` | cache/annotation/MultiLevelCache.java | å£°æ˜å¼ç¼“å­˜æ³¨è§£ |
| `@CacheEvict` | cache/annotation/CacheEvict.java | ç¼“å­˜æ¸…é™¤æ³¨è§£ |
| `MultiLevelCacheAspect` | cache/aspect/MultiLevelCacheAspect.java | AOPåˆ‡é¢å®ç° |

### 3. ç¤ºä¾‹å’Œæ–‡æ¡£ (3ä¸ªæ–‡ä»¶)

| æ–‡ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| `CacheUsageExample` | cache/example/CacheUsageExample.java | 10ä¸ªä½¿ç”¨ç¤ºä¾‹ |
| `README.md` | cache/README.md | å®Œæ•´çš„ä½¿ç”¨æ–‡æ¡£ |
| `application-cache.yml` | resources/application-cache.yml | é…ç½®ç¤ºä¾‹ |

## äºŒã€æ¶æ„è®¾è®¡

### ç¼“å­˜æµç¨‹

```
è¯·æ±‚ â†’ L1ç¼“å­˜(Caffeine) â†’ L2ç¼“å­˜(Redis) â†’ æ•°æ®æº(MySQL)
         â†“ å‘½ä¸­              â†“ å‘½ä¸­            â†“ åŠ è½½
       è¿”å›æ•°æ® â†â”€â”€â”€â”€â”€â”€â”€ è¿”å›æ•°æ® â†â”€â”€â”€â”€â”€â”€â”€ è¿”å›æ•°æ®
                           â†“                  â†“
                        å›å¡«L1 â†â”€â”€â”€â”€â”€â”€â”€ å†™å…¥L1+L2
```

### æ ¸å¿ƒç‰¹æ€§

âœ… **å¤šçº§ç¼“å­˜**: L1(Caffeine) + L2(Redis) åŒå±‚æ¶æ„  
âœ… **å£°æ˜å¼ç¼“å­˜**: åŸºäºæ³¨è§£çš„AOPå®ç°  
âœ… **ç¼–ç¨‹å¼ç¼“å­˜**: çµæ´»çš„APIæ”¯æŒ  
âœ… **ç¼“å­˜ç»Ÿè®¡**: å‘½ä¸­ç‡ã€é©±é€ç‡å®æ—¶ç›‘æ§  
âœ… **SpELæ”¯æŒ**: åŠ¨æ€ç¼“å­˜é”®ç”Ÿæˆ  
âœ… **å¤šç¼“å­˜å®ä¾‹**: defaultã€hotDataã€userSessionã€dictionary  
âœ… **æ¡ä»¶ç¼“å­˜**: æ”¯æŒæ¡ä»¶è¡¨è¾¾å¼  
âœ… **è‡ªåŠ¨å›å¡«**: L2å‘½ä¸­åè‡ªåŠ¨å›å¡«L1  

## ä¸‰ã€ä½¿ç”¨æ–¹å¼

### æ–¹å¼1: æ³¨è§£æ–¹å¼(æ¨è)

```java
@Service
public class UserService {
    
    @MultiLevelCache(
        namespace = "user",
        key = "#userId",
        level = CacheLevel.L1_AND_L2,
        expireSeconds = 300
    )
    public User getUserById(Long userId) {
        return userMapper.selectById(userId);
    }
    
    @CacheEvict(
        namespace = "user",
        key = "#user.id",
        level = CacheLevel.L1_AND_L2
    )
    public void updateUser(User user) {
        userMapper.updateById(user);
    }
}
```

### æ–¹å¼2: ç¼–ç¨‹æ–¹å¼

```java
@Service
public class UserService {
    @Autowired
    private MultiLevelCacheManager cacheManager;
    
    public User getUserById(Long userId) {
        CacheKey key = CacheKey.of("user", String.valueOf(userId));
        return cacheManager.get(key, CacheLevel.L1_AND_L2, 
            () -> userMapper.selectById(userId), 300);
    }
}
```

## å››ã€é…ç½®è¯´æ˜

### application.ymlé…ç½®

```yaml
his:
  cache:
    caffeine:
      initial-capacity: 100      # åˆå§‹å®¹é‡
      maximum-size: 1000         # æœ€å¤§å®¹é‡
      expire-after-write: 300    # å†™åè¿‡æœŸæ—¶é—´(ç§’)
      expire-after-access: 180   # è®¿é—®åè¿‡æœŸæ—¶é—´(ç§’)
      record-stats: true         # å¯ç”¨ç»Ÿè®¡
```

### ç¼“å­˜å®ä¾‹é…ç½®

| å®ä¾‹å | å®¹é‡ | è¿‡æœŸæ—¶é—´ | é€‚ç”¨åœºæ™¯ |
|--------|------|---------|---------|
| default | 1000 | 5åˆ†é’Ÿ | é€šç”¨æ•°æ® |
| hotData | 5000 | 3åˆ†é’Ÿ | çƒ­ç‚¹æ•°æ® |
| userSession | 2000 | 30åˆ†é’Ÿ | ç”¨æˆ·ä¼šè¯ |
| dictionary | 1000 | 60åˆ†é’Ÿ | å­—å…¸æ•°æ® |

## äº”ã€ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯1: ç”¨æˆ·ä¿¡æ¯ç¼“å­˜

```java
@MultiLevelCache(namespace = "user", key = "#userId", 
                 level = CacheLevel.L1_AND_L2, expireSeconds = 300)
public User getUserById(Long userId) {
    return userMapper.selectById(userId);
}
```

### åœºæ™¯2: çƒ­ç‚¹æ•°æ®ç¼“å­˜

```java
@MultiLevelCache(namespace = "hot", key = "#id", 
                 level = CacheLevel.L1_AND_L2, 
                 cacheName = "hotData", expireSeconds = 180)
public HotData getHotData(Long id) {
    return dataMapper.selectById(id);
}
```

### åœºæ™¯3: å­—å…¸æ•°æ®ç¼“å­˜

```java
@MultiLevelCache(namespace = "dict", key = "#type", 
                 level = CacheLevel.L1_AND_L2,
                 cacheName = "dictionary", expireSeconds = 3600)
public List<DictItem> getDictByType(String type) {
    return dictMapper.selectByType(type);
}
```

### åœºæ™¯4: æ¡ä»¶ç¼“å­˜

```java
@MultiLevelCache(namespace = "user", key = "#userId",
                 level = CacheLevel.L1_AND_L2,
                 condition = "#result != null")
public User getUserById(Long userId) {
    return userMapper.selectById(userId);
}
```

## å…­ã€æ€§èƒ½ä¼˜åŒ–

### 1. å‘½ä¸­ç‡ä¼˜åŒ–
- åˆç†è®¾ç½®ç¼“å­˜å®¹é‡å’Œè¿‡æœŸæ—¶é—´
- ä½¿ç”¨çƒ­ç‚¹æ•°æ®ç¼“å­˜å®ä¾‹
- ç›‘æ§ç¼“å­˜ç»Ÿè®¡æ•°æ®

### 2. å†…å­˜ä¼˜åŒ–
- é¿å…ç¼“å­˜å¤§å¯¹è±¡
- è®¾ç½®åˆç†çš„æœ€å¤§å®¹é‡
- å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜

### 3. ä¸€è‡´æ€§ä¿è¯
- æ›´æ–°æ•°æ®æ—¶åŠæ—¶æ¸…é™¤ç¼“å­˜
- ä½¿ç”¨@CacheEvictæ³¨è§£
- è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´

## ä¸ƒã€ç›‘æ§ç»Ÿè®¡

### æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡

```java
@Autowired
private CacheStatistics cacheStatistics;

// æ‰“å°æ‰€æœ‰ç¼“å­˜ç»Ÿè®¡
cacheStatistics.printAllCacheStats();

// è·å–ç»Ÿè®¡æ•°æ®
Map<String, CacheStatsInfo> stats = cacheStatistics.getAllCacheStats();
```

### ç»Ÿè®¡æŒ‡æ ‡

- å‘½ä¸­ç‡ (hitRate)
- æœªå‘½ä¸­ç‡ (missRate)
- é©±é€æ¬¡æ•° (evictionCount)
- å¹³å‡åŠ è½½æ—¶é—´ (averageLoadPenalty)

## å…«ã€ä¾èµ–è¯´æ˜

### æ–°å¢ä¾èµ–

```xml
<!-- Caffeineæœ¬åœ°ç¼“å­˜ -->
<dependency>
    <groupId>com.github.ben-manes.caffeine</groupId>
    <artifactId>caffeine</artifactId>
    <version>2.9.3</version>
</dependency>

<!-- Spring AOPæ”¯æŒ -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-aop</artifactId>
</dependency>
```

### å·²æœ‰ä¾èµ–

- spring-boot-starter-data-redis (Redisæ”¯æŒ)
- spring-boot-starter (Spring Bootæ ¸å¿ƒ)

## ä¹ã€æœ€ä½³å®è·µ

1. âœ… **ä¼˜å…ˆä½¿ç”¨æ³¨è§£æ–¹å¼**: ä»£ç ç®€æ´,æ˜“ç»´æŠ¤
2. âœ… **è®¾ç½®åˆç†çš„å‘½åç©ºé—´**: ä¾¿äºç®¡ç†å’Œæ‰¹é‡æ¸…é™¤
3. âœ… **ç›‘æ§ç¼“å­˜æ€§èƒ½**: å®šæœŸæŸ¥çœ‹ç»Ÿè®¡æ•°æ®
4. âœ… **åŠæ—¶æ¸…é™¤ç¼“å­˜**: ä½¿ç”¨@CacheEvictæ³¨è§£
5. âœ… **é¿å…ç¼“å­˜ç©¿é€**: ç¼“å­˜nullå€¼
6. âœ… **æµ‹è¯•ç¼“å­˜é€»è¾‘**: ç¡®ä¿ç¼“å­˜æ›´æ–°æ­£ç¡®

## åã€æ³¨æ„äº‹é¡¹

âš ï¸ **åºåˆ—åŒ–é—®é¢˜**: Redisç¼“å­˜çš„å¯¹è±¡éœ€è¦å®ç°Serializable  
âš ï¸ **ç¼“å­˜ä¸€è‡´æ€§**: æ›´æ–°æ•°æ®æ—¶è¦åŒæ­¥æ¸…é™¤ç¼“å­˜  
âš ï¸ **å†…å­˜ç®¡ç†**: åˆç†è®¾ç½®ç¼“å­˜å®¹é‡,é¿å…OOM  
âš ï¸ **å¹¶å‘é—®é¢˜**: MultiLevelCacheManageræ˜¯çº¿ç¨‹å®‰å…¨çš„  
âš ï¸ **åˆ†å¸ƒå¼ç¯å¢ƒ**: L1ç¼“å­˜åœ¨å„å®ä¾‹ç‹¬ç«‹,æ³¨æ„æ•°æ®ä¸€è‡´æ€§  

## åä¸€ã€æµ‹è¯•éªŒè¯

å·²åˆ›å»ºæµ‹è¯•ç±»: `MultiLevelCacheTest.java`

åŒ…å«ä»¥ä¸‹æµ‹è¯•åœºæ™¯:
- âœ… å¤šçº§ç¼“å­˜åŸºæœ¬åŠŸèƒ½æµ‹è¯•
- âœ… ç¼“å­˜ç»Ÿè®¡åŠŸèƒ½æµ‹è¯•
- âœ… ä¸åŒç¼“å­˜çº§åˆ«æµ‹è¯•

## åäºŒã€æ–‡ä»¶æ¸…å•

```
HIS-common/
â”œâ”€â”€ src/main/java/com/neu/his/common/cache/
â”‚   â”œâ”€â”€ CacheLevel.java                      # ç¼“å­˜çº§åˆ«æšä¸¾
â”‚   â”œâ”€â”€ CacheKey.java                        # ç¼“å­˜é”®å°è£…
â”‚   â”œâ”€â”€ MultiLevelCacheManager.java          # å¤šçº§ç¼“å­˜ç®¡ç†å™¨
â”‚   â”œâ”€â”€ annotation/
â”‚   â”‚   â”œâ”€â”€ MultiLevelCache.java             # ç¼“å­˜æ³¨è§£
â”‚   â”‚   â””â”€â”€ CacheEvict.java                  # æ¸…é™¤æ³¨è§£
â”‚   â”œâ”€â”€ aspect/
â”‚   â”‚   â””â”€â”€ MultiLevelCacheAspect.java       # AOPåˆ‡é¢
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ CaffeineCacheConfig.java         # Caffeineé…ç½®
â”‚   â”‚   â””â”€â”€ CaffeineCacheProperties.java     # é…ç½®å±æ€§
â”‚   â”œâ”€â”€ stats/
â”‚   â”‚   â””â”€â”€ CacheStatistics.java             # ç¼“å­˜ç»Ÿè®¡
â”‚   â”œâ”€â”€ example/
â”‚   â”‚   â””â”€â”€ CacheUsageExample.java           # ä½¿ç”¨ç¤ºä¾‹
â”‚   â””â”€â”€ README.md                             # ä½¿ç”¨æ–‡æ¡£
â”œâ”€â”€ src/main/resources/
â”‚   â””â”€â”€ application-cache.yml                 # é…ç½®ç¤ºä¾‹
â”œâ”€â”€ src/test/java/com/neu/his/common/cache/
â”‚   â””â”€â”€ MultiLevelCacheTest.java              # å•å…ƒæµ‹è¯•
â””â”€â”€ pom.xml                                    # ä¾èµ–é…ç½®(å·²æ›´æ–°)
```

## åä¸‰ã€å¿«é€Ÿå¼€å§‹

### 1. å¯ç”¨é…ç½®
åœ¨application.ymlä¸­å¼•å…¥é…ç½®:
```yaml
spring:
  profiles:
    include: cache
```

### 2. ä½¿ç”¨ç¤ºä¾‹
å‚è€ƒ `CacheUsageExample.java` ä¸­çš„10ä¸ªç¤ºä¾‹

### 3. æŸ¥çœ‹æ–‡æ¡£
é˜…è¯» `cache/README.md` äº†è§£è¯¦ç»†ä¿¡æ¯

---

**å®ç°å®Œæˆ! å¤šçº§ç¼“å­˜ç­–ç•¥å·²æˆåŠŸé›†æˆåˆ°HISç³»ç»Ÿä¸­ã€‚** ğŸ‰
