# HIS系统日志管理优化说明

## 优化概述

本次优化对HIS医院信息系统的日志管理进行了全面升级,主要包括日志配置、日志工具、日志切面和日志过滤器等多个方面的优化。

## 优化内容

### 1. Logback配置优化

#### 主要改进
- **日志分级输出**: 将日志按照INFO、WARN、ERROR三个级别分别输出到不同文件
- **异步日志**: 使用AsyncAppender实现异步日志输出,提升系统性能
- **文件大小控制**: 
  - 单文件最大100MB
  - 按日期和大小进行滚动
  - INFO日志保留30天,ERROR日志保留90天
- **总容量限制**: INFO日志总容量10GB,WARN日志5GB,ERROR日志10GB
- **更丰富的日志格式**: 包含时间戳、线程、级别、类名等详细信息

#### 配置文件位置
- `/HIS-master/HIS-api/src/main/resources/logback-spring.xml`
- `/his-cloud/his-cloud-zuul/src/main/resources/logback-spring.xml`

#### 日志文件输出位置
默认输出到 `/tmp/logs/` 目录下,文件命名规则:
- `his-info-{date}.{index}.log` - INFO级别日志
- `his-warn-{date}.{index}.log` - WARN级别日志
- `his-error-{date}.{index}.log` - ERROR级别日志

### 2. WebLog实体类优化

#### 改进内容
- 使用Lombok注解简化代码(@Data、@Builder等)
- 实现Serializable接口,支持序列化
- 新增字段:
  - `os`: 操作系统信息
  - `browser`: 浏览器信息
  - `exceptionMessage`: 异常信息

#### 文件位置
`/HIS-master/HIS-api/src/main/java/com/neu/his/bo/WebLog.java`

### 3. 日志工具类(LogUtil)

#### 主要功能
1. **敏感信息脱敏**
   - 手机号脱敏: 138****8888
   - 身份证号脱敏: 110***********1234
   - 姓名脱敏: 张*、李**
   - 密码完全隐藏: ******
   - 银行卡号脱敏: 6222****1234
   - 邮箱脱敏: t***@example.com

2. **业务日志记录**
   - `logBusiness()`: 记录业务操作日志
   - `logPerformance()`: 记录性能日志(根据耗时自动分级)
   - `logDatabase()`: 记录数据库操作日志
   - `logExternalApi()`: 记录外部接口调用日志

3. **异常格式化**
   - `formatException()`: 格式化异常堆栈信息(只保留前5层)

#### 文件位置
`/HIS-master/HIS-common/src/main/java/com/neu/his/common/util/LogUtil.java`

#### 使用示例
```java
// 脱敏手机号
String phone = LogUtil.desensitizePhone("13812345678");
// 输出: 138****5678

// 记录业务日志
LogUtil.logBusiness(logger, "张三", "挂号", "挂号成功");

// 记录性能日志
LogUtil.logPerformance(logger, "queryPatients", 1500);
```

### 4. 日志常量定义(LogConstants)

#### 主要常量
- **LogType**: 日志类型(业务、系统、操作、异常、性能等)
- **OperationType**: 操作类型(查询、新增、更新、删除、登录等)
- **BusinessModule**: 业务模块(用户、患者、医生、挂号等)
- **LogStatus**: 日志状态(成功、失败、异常)
- **SensitiveField**: 敏感字段名称
- **PerformanceThreshold**: 性能阈值

#### 文件位置
`/HIS-master/HIS-common/src/main/java/com/neu/his/common/constant/LogConstants.java`

### 5. WebLogAspect切面优化

#### 新增功能
1. **异常日志记录**: 使用@AfterThrowing捕获并记录所有Controller层异常
2. **敏感信息脱敏**: 自动对密码等敏感信息进行脱敏
3. **真实IP获取**: 支持代理环境下获取真实客户端IP
4. **系统信息采集**: 自动识别操作系统和浏览器类型
5. **慢接口告警**: 超过3秒的接口会以WARN级别输出
6. **结果大小控制**: 超过10000字符的返回结果会被截断

#### 文件位置
`/HIS-master/HIS-api/src/main/java/com/neu/his/component/WebLogAspect.java`

### 6. 日志配置属性类(LoggingProperties)

#### 可配置项
- 是否启用各类日志(请求、性能、SQL、异常)
- 是否启用敏感信息脱敏
- 慢接口/慢SQL阈值
- 日志保留天数
- 文件大小限制
- 是否启用异步日志
- ELK集成配置

#### 文件位置
`/HIS-master/HIS-common/src/main/java/com/neu/his/config/LoggingProperties.java`

#### 使用方式
在`application.yml`中配置:
```yaml
his:
  logging:
    enable-request-log: true
    enable-performance-log: true
    enable-desensitization: true
    slow-api-threshold: 3000
    slow-sql-threshold: 1000
    retention-days: 30
```

### 7. 日志追踪过滤器(LogTraceFilter)

#### 主要功能
- 为每个HTTP请求生成唯一的TraceId
- 使用MDC(Mapped Diagnostic Context)在整个请求链路中传递TraceId
- 支持分布式链路追踪
- 自动记录请求URI

#### 文件位置
`/HIS-master/HIS-common/src/main/java/com/neu/his/filter/LogTraceFilter.java`

#### MDC支持的字段
- `traceId`: 请求追踪ID
- `userId`: 用户ID(需要自行实现获取逻辑)
- `requestUri`: 请求URI

### 8. 操作日志注解(OperationLog)

#### 注解属性
- `module`: 业务模块
- `operation`: 操作类型
- `description`: 操作描述
- `saveRequestData`: 是否保存请求参数
- `saveResponseData`: 是否保存响应结果

#### 文件位置
`/HIS-master/HIS-common/src/main/java/com/neu/his/annotation/OperationLog.java`

#### 使用示例
```java
@OperationLog(
    module = "患者管理", 
    operation = "新增", 
    description = "新增患者信息"
)
public CommonResult addPatient(@RequestBody Patient patient) {
    // 业务逻辑
}
```

## 日志级别使用规范

### DEBUG
- 详细的调试信息
- 方法入参、出参
- 中间变量的值
- 仅在开发和测试环境使用

### INFO
- 重要的业务流程节点
- 外部接口调用
- 定时任务执行
- 系统启动/停止信息

### WARN
- 可恢复的异常
- 性能问题(慢接口、慢SQL)
- 配置缺失但有默认值
- 即将废弃的功能使用

### ERROR
- 系统错误
- 业务异常
- 数据异常
- 第三方服务调用失败

## 性能优化建议

### 1. 异步日志
生产环境建议启用异步日志,减少日志IO对业务的影响:
```yaml
his:
  logging:
    enable-async-log: true
    async-queue-size: 512
```

### 2. 日志级别
- 开发环境: DEBUG
- 测试环境: INFO
- 生产环境: INFO或WARN

### 3. 日志采样
对于高并发接口,可以考虑日志采样,只记录部分请求的详细日志。

### 4. 日志清理
定期清理过期日志文件,避免磁盘空间不足:
```bash
# 删除30天前的日志
find /tmp/logs -name "*.log" -mtime +30 -delete
```

## ELK集成说明

### 1. 启用Logstash
在`logback-spring.xml`中取消以下注释:
```xml
<appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
    <destination>localhost:4560</destination>
    <encoder charset="UTF-8" class="net.logstash.logback.encoder.LogstashEncoder">
        <customFields>{"appname":"his","env":"prod"}</customFields>
    </encoder>
</appender>
```

### 2. 配置Logstash地址
```yaml
his:
  logging:
    enable-elk: true
    logstash-host: "logstash-server:4560"
```

### 3. 日志字段说明
输出到ELK的日志包含以下结构化字段:
- `@timestamp`: 时间戳
- `level`: 日志级别
- `logger_name`: 日志记录器名称
- `thread_name`: 线程名称
- `message`: 日志消息
- `type`: 日志类型
- `traceId`: 追踪ID
- `url`, `method`, `ip`: 请求信息
- `spendTime`: 耗时

## 监控告警建议

### 1. 错误日志监控
建议对ERROR级别日志设置告警:
- 1分钟内ERROR日志超过10条
- 出现特定关键字的错误(如"数据库连接失败")

### 2. 性能监控
- 慢接口统计(超过3秒的接口)
- 平均响应时间趋势
- QPS统计

### 3. 业务监控
- 登录失败次数
- 重要业务操作的执行情况
- 异常操作告警

## 常见问题

### Q1: 日志文件过大,如何处理?
A: 调整`maxFileSize`和`maxHistory`参数,或减少日志输出级别。

### Q2: 如何查看某个请求的完整日志?
A: 通过TraceId进行检索,在日志中搜索对应的TraceId即可。

### Q3: 敏感信息脱敏规则如何自定义?
A: 修改`LogUtil`类中的脱敏方法,或在`WebLogAspect`中的`desensitizeJson`方法中添加自定义规则。

### Q4: 如何临时提升某个包的日志级别?
A: 在`logback-spring.xml`中添加logger配置:
```xml
<logger name="com.neu.his.某个包" level="DEBUG"/>
```

## 后续优化计划

1. [ ] 实现日志数据持久化到数据库
2. [ ] 开发日志查询和分析界面
3. [ ] 集成更多的监控告警平台
4. [ ] 实现日志的自动归档和备份
5. [ ] 添加更多的业务日志埋点

## 总结

本次日志管理优化大幅提升了系统的可观测性和可维护性:
- ✅ 结构化日志输出,便于检索和分析
- ✅ 敏感信息自动脱敏,保护用户隐私
- ✅ 异步日志输出,提升系统性能
- ✅ 完善的日志分级和归档策略
- ✅ 支持分布式链路追踪
- ✅ 预留ELK集成接口

建议在生产环境部署前,充分测试日志功能,确保日志输出正常且不影响系统性能。
