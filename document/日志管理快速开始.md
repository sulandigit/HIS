# æ—¥å¿—ç®¡ç†ä¼˜åŒ– - å¿«é€Ÿå¼€å§‹æŒ‡å—

## ä¸€ã€æ–‡ä»¶æ¸…å•

### 1. é…ç½®æ–‡ä»¶
- âœ… `HIS-master/HIS-api/src/main/resources/logback-spring.xml` - ä¸»åº”ç”¨æ—¥å¿—é…ç½®
- âœ… `his-cloud/his-cloud-zuul/src/main/resources/logback-spring.xml` - Zuulç½‘å…³æ—¥å¿—é…ç½®
- âœ… `document/logging-config-example.yml` - æ—¥å¿—é…ç½®ç¤ºä¾‹

### 2. Javaç±»æ–‡ä»¶
- âœ… `HIS-master/HIS-api/src/main/java/com/neu/his/bo/WebLog.java` - Webæ—¥å¿—å®ä½“ç±»(å·²ä¼˜åŒ–)
- âœ… `HIS-master/HIS-api/src/main/java/com/neu/his/component/WebLogAspect.java` - æ—¥å¿—åˆ‡é¢(å·²ä¼˜åŒ–)
- âœ… `HIS-master/HIS-common/src/main/java/com/neu/his/common/util/LogUtil.java` - æ—¥å¿—å·¥å…·ç±»(æ–°å¢)
- âœ… `HIS-master/HIS-common/src/main/java/com/neu/his/common/constant/LogConstants.java` - æ—¥å¿—å¸¸é‡(æ–°å¢)
- âœ… `HIS-master/HIS-common/src/main/java/com/neu/his/config/LoggingProperties.java` - æ—¥å¿—é…ç½®å±æ€§(æ–°å¢)
- âœ… `HIS-master/HIS-common/src/main/java/com/neu/his/filter/LogTraceFilter.java` - æ—¥å¿—è¿½è¸ªè¿‡æ»¤å™¨(æ–°å¢)
- âœ… `HIS-master/HIS-common/src/main/java/com/neu/his/annotation/OperationLog.java` - æ“ä½œæ—¥å¿—æ³¨è§£(æ–°å¢)

### 3. æ–‡æ¡£æ–‡ä»¶
- âœ… `document/æ—¥å¿—ç®¡ç†ä¼˜åŒ–è¯´æ˜.md` - è¯¦ç»†ä¼˜åŒ–è¯´æ˜æ–‡æ¡£
- âœ… `document/logging-config-example.yml` - é…ç½®ç¤ºä¾‹æ–‡ä»¶
- âœ… `document/æ—¥å¿—ç®¡ç†å¿«é€Ÿå¼€å§‹.md` - æœ¬æ–‡æ¡£

## äºŒã€ç«‹å³ä½¿ç”¨(æ— éœ€é¢å¤–é…ç½®)

### 1. è‡ªåŠ¨ç”Ÿæ•ˆçš„åŠŸèƒ½
ä»¥ä¸‹åŠŸèƒ½å·²è‡ªåŠ¨å¯ç”¨,æ— éœ€ä»»ä½•é…ç½®:

âœ… **æ—¥å¿—åˆ†çº§è¾“å‡º**
- INFOæ—¥å¿—: `/tmp/logs/his-info-{date}.{index}.log`
- WARNæ—¥å¿—: `/tmp/logs/his-warn-{date}.{index}.log`
- ERRORæ—¥å¿—: `/tmp/logs/his-error-{date}.{index}.log`

âœ… **å¼‚æ­¥æ—¥å¿—**
- æå‡ç³»ç»Ÿæ€§èƒ½,å‡å°‘IOé˜»å¡

âœ… **è¯·æ±‚æ—¥å¿—è®°å½•**
- è‡ªåŠ¨è®°å½•æ‰€æœ‰Controlleræ¥å£çš„è®¿é—®æ—¥å¿—
- åŒ…å«URLã€å‚æ•°ã€è€—æ—¶ã€IPç­‰ä¿¡æ¯

âœ… **å¼‚å¸¸æ—¥å¿—è®°å½•**
- è‡ªåŠ¨æ•è·å¹¶è®°å½•Controllerå±‚çš„æ‰€æœ‰å¼‚å¸¸

âœ… **æ…¢æ¥å£å‘Šè­¦**
- è¶…è¿‡3ç§’çš„æ¥å£è‡ªåŠ¨WARNçº§åˆ«è¾“å‡º

âœ… **TraceIdè¿½è¸ª**
- æ¯ä¸ªè¯·æ±‚è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€TraceId,æ–¹ä¾¿é“¾è·¯è¿½è¸ª

### 2. æŸ¥çœ‹æ—¥å¿—
```bash
# æŸ¥çœ‹INFOæ—¥å¿—
tail -f /tmp/logs/his-info-{å½“å‰æ—¥æœŸ}.0.log

# æŸ¥çœ‹ERRORæ—¥å¿—
tail -f /tmp/logs/his-error-{å½“å‰æ—¥æœŸ}.0.log

# æœç´¢ç‰¹å®šTraceIdçš„æ—¥å¿—
grep "traceId_value" /tmp/logs/his-info-*.log

# æŸ¥çœ‹æ…¢æ¥å£
grep "æ…¢æ¥å£" /tmp/logs/his-warn-*.log
```

## ä¸‰ã€å¯é€‰é…ç½®

### 1. æ·»åŠ æ—¥å¿—é…ç½®(application.yml)
```yaml
his:
  logging:
    enable-desensitization: true  # å¯ç”¨æ•æ„Ÿä¿¡æ¯è„±æ•
    slow-api-threshold: 3000      # æ…¢æ¥å£é˜ˆå€¼(æ¯«ç§’)
```

### 2. ä½¿ç”¨æ—¥å¿—å·¥å…·ç±»
```java
import com.neu.his.common.util.LogUtil;

// è„±æ•æ‰‹æœºå·
String phone = LogUtil.desensitizePhone("13812345678");
// è¾“å‡º: 138****5678

// è„±æ•èº«ä»½è¯
String idCard = LogUtil.desensitizeIdCard("110101199001011234");
// è¾“å‡º: 110***********1234

// è®°å½•ä¸šåŠ¡æ—¥å¿—
LogUtil.logBusiness(logger, username, "æŒ‚å·", "æŒ‚å·æˆåŠŸ");

// è®°å½•æ€§èƒ½æ—¥å¿—
long startTime = System.currentTimeMillis();
// ... ä¸šåŠ¡ä»£ç 
LogUtil.logPerformance(logger, "methodName", System.currentTimeMillis() - startTime);
```

### 3. ä½¿ç”¨æ“ä½œæ—¥å¿—æ³¨è§£
```java
import com.neu.his.annotation.OperationLog;
import com.neu.his.common.constant.LogConstants;

@OperationLog(
    module = LogConstants.BusinessModule.PATIENT,
    operation = LogConstants.OperationType.INSERT,
    description = "æ–°å¢æ‚£è€…ä¿¡æ¯"
)
public CommonResult addPatient(@RequestBody Patient patient) {
    // ä¸šåŠ¡ä»£ç 
}
```

## å››ã€é«˜çº§åŠŸèƒ½

### 1. å¯ç”¨ELKæ—¥å¿—æ”¶é›†

#### æ­¥éª¤1: ä¿®æ”¹logback-spring.xml
å–æ¶ˆä»¥ä¸‹æ³¨é‡Š:
```xml
<appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
    <destination>localhost:4560</destination>
    <encoder charset="UTF-8" class="net.logstash.logback.encoder.LogstashEncoder">
        <customFields>{"appname":"his","env":"prod"}</customFields>
    </encoder>
</appender>
```

åœ¨`<root>`ä¸­æ·»åŠ :
```xml
<appender-ref ref="LOGSTASH"/>
```

#### æ­¥éª¤2: é…ç½®Logstashåœ°å€
```yaml
his:
  logging:
    enable-elk: true
    logstash-host: your-logstash-server:4560
```

### 2. è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼

ä¿®æ”¹ `logback-spring.xml` ä¸­çš„ `LOG_PATTERN`:
```xml
<property name="LOG_PATTERN" 
    value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{traceId}] [%thread] %-5level %logger{50} - %msg%n"/>
```

### 3. è°ƒæ•´æ—¥å¿—çº§åˆ«

#### ä¸´æ—¶è°ƒæ•´(é‡å¯åå¤±æ•ˆ)
åœ¨ `application.yml` ä¸­:
```yaml
logging:
  level:
    com.neu.his.æŸä¸ªåŒ…: DEBUG
```

#### æ°¸ä¹…è°ƒæ•´
ä¿®æ”¹ `logback-spring.xml`:
```xml
<logger name="com.neu.his.æŸä¸ªåŒ…" level="DEBUG"/>
```

### 4. è‡ªå®šä¹‰æ•æ„Ÿä¿¡æ¯è„±æ•è§„åˆ™

ç¼–è¾‘ `LogUtil.java`,æ·»åŠ è‡ªå®šä¹‰è„±æ•æ–¹æ³•:
```java
public static String desensitizeCustom(String data) {
    // è‡ªå®šä¹‰è„±æ•é€»è¾‘
    return data;
}
```

åœ¨ `WebLogAspect.java` çš„ `desensitizeJson()` æ–¹æ³•ä¸­ä½¿ç”¨:
```java
json = json.replaceAll("è‡ªå®šä¹‰æ­£åˆ™", "æ›¿æ¢å€¼");
```

## äº”ã€æ—¥å¿—ç›‘æ§å»ºè®®

### 1. é”™è¯¯æ—¥å¿—ç›‘æ§
```bash
# å®æ—¶ç›‘æ§é”™è¯¯æ—¥å¿—
tail -f /tmp/logs/his-error-*.log | grep -i "error"

# ç»Ÿè®¡æ¯å°æ—¶é”™è¯¯æ•°é‡
grep "ERROR" /tmp/logs/his-error-$(date +%Y-%m-%d).*.log | wc -l
```

### 2. æ…¢æ¥å£ç›‘æ§
```bash
# æŸ¥æ‰¾æ‰€æœ‰æ…¢æ¥å£
grep "æ…¢æ¥å£" /tmp/logs/his-warn-*.log

# ç»Ÿè®¡æ…¢æ¥å£TOP10
grep "spendTime" /tmp/logs/his-info-*.log | \
    awk '{print $NF}' | sort -rn | head -10
```

### 3. æŒ‰TraceIdè¿½è¸ªè¯·æ±‚
```bash
# æŸ¥æ‰¾æŸä¸ªTraceIdçš„å®Œæ•´è¯·æ±‚æ—¥å¿—
TRACE_ID="your_trace_id"
grep $TRACE_ID /tmp/logs/his-*.log
```

## å…­ã€æ€§èƒ½è°ƒä¼˜

### 1. ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–

åœ¨ `application-prod.yml` ä¸­:
```yaml
logging:
  level:
    root: WARN
    com.neu.his: INFO  # é™ä½æ—¥å¿—çº§åˆ«

his:
  logging:
    enable-async-log: true  # å¯ç”¨å¼‚æ­¥
    async-queue-size: 1024  # å¢åŠ é˜Ÿåˆ—å¤§å°
    enable-sql-log: false   # å…³é—­SQLè¯¦ç»†æ—¥å¿—
```

### 2. æ—¥å¿—æ–‡ä»¶æ¸…ç†

åˆ›å»ºå®šæ—¶ä»»åŠ¡æ¸…ç†æ—§æ—¥å¿—:
```bash
# æ·»åŠ åˆ°crontab
0 2 * * * find /tmp/logs -name "*.log" -mtime +30 -delete
```

### 3. è°ƒæ•´æ—¥å¿—æ–‡ä»¶å¤§å°

ä¿®æ”¹ `logback-spring.xml`:
```xml
<maxFileSize>200MB</maxFileSize>  <!-- å¢åŠ å•æ–‡ä»¶å¤§å° -->
<maxHistory>60</maxHistory>        <!-- å¢åŠ ä¿ç•™å¤©æ•° -->
<totalSizeCap>20GB</totalSizeCap>  <!-- å¢åŠ æ€»å®¹é‡ -->
```

## ä¸ƒã€å¸¸è§é—®é¢˜æ’æŸ¥

### Q1: æ—¥å¿—æ²¡æœ‰è¾“å‡ºåˆ°æ–‡ä»¶
**æ£€æŸ¥æ­¥éª¤:**
1. ç¡®è®¤ `/tmp/logs` ç›®å½•æœ‰å†™æƒé™
2. æ£€æŸ¥ `logback-spring.xml` é…ç½®æ˜¯å¦æ­£ç¡®
3. æŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æœ‰logbackåˆå§‹åŒ–é”™è¯¯

### Q2: æ—¥å¿—è¾“å‡ºä¹±ç 
**è§£å†³æ–¹æ¡ˆ:**
åœ¨ `logback-spring.xml` ä¸­ç¡®è®¤ç¼–ç è®¾ç½®:
```xml
<encoder>
    <charset>UTF-8</charset>
</encoder>
```

### Q3: å¼‚æ­¥æ—¥å¿—ä¸¢å¤±
**è§£å†³æ–¹æ¡ˆ:**
è°ƒæ•´ `discardingThreshold`:
```xml
<appender name="ASYNC_INFO_FILE" class="ch.qos.logback.classic.AsyncAppender">
    <discardingThreshold>0</discardingThreshold>  <!-- è®¾ç½®ä¸º0ä¸ä¸¢å¼ƒ -->
</appender>
```

### Q4: æ•æ„Ÿä¿¡æ¯è„±æ•ä¸ç”Ÿæ•ˆ
**æ£€æŸ¥æ­¥éª¤:**
1. ç¡®è®¤é…ç½®å¯ç”¨: `enable-desensitization: true`
2. æ£€æŸ¥ `WebLogAspect` ä¸­çš„è„±æ•é€»è¾‘
3. æŸ¥çœ‹æ˜¯å¦æ˜¯æ–°å¢çš„æ•æ„Ÿå­—æ®µéœ€è¦æ·»åŠ è§„åˆ™

## å…«ã€ä¸‹ä¸€æ­¥

### å»ºè®®æ“ä½œ:
1. âœ… éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒéªŒè¯åŠŸèƒ½
2. âœ… æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´æ—¥å¿—çº§åˆ«å’Œä¿ç•™ç­–ç•¥
3. âœ… é…ç½®æ—¥å¿—ç›‘æ§å‘Šè­¦
4. âœ… é›†æˆELKè¿›è¡Œæ—¥å¿—åˆ†æ
5. âœ… å®šæœŸæ£€æŸ¥å’Œæ¸…ç†æ—¥å¿—æ–‡ä»¶

### æ¨èé˜…è¯»:
- `document/æ—¥å¿—ç®¡ç†ä¼˜åŒ–è¯´æ˜.md` - è¯¦ç»†åŠŸèƒ½è¯´æ˜
- `document/logging-config-example.yml` - å®Œæ•´é…ç½®ç¤ºä¾‹

## ä¹ã€æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜,è¯·æŸ¥çœ‹:
1. è¯¦ç»†æ–‡æ¡£: `document/æ—¥å¿—ç®¡ç†ä¼˜åŒ–è¯´æ˜.md`
2. é…ç½®ç¤ºä¾‹: `document/logging-config-example.yml`
3. æºä»£ç æ³¨é‡Š

---

**é‡è¦æç¤º:**
- ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰è¯·å……åˆ†æµ‹è¯•
- æ³¨æ„æ—¥å¿—æ–‡ä»¶å ç”¨çš„ç£ç›˜ç©ºé—´
- å»ºè®®é…ç½®æ—¥å¿—å‘Šè­¦ç›‘æ§
- å®šæœŸå®¡æŸ¥å’Œä¼˜åŒ–æ—¥å¿—è¾“å‡º

ç¥ä½¿ç”¨æ„‰å¿«! ğŸ‰
