# 事务超时和回滚策略配置清单

## 配置概览

### ✅ 已完成的配置

#### 1. 核心配置文件
- [x] `TransactionConfig.java` - 全局事务管理器配置
- [x] `TransactionAspect.java` - 事务切面监控
- [x] `GlobalExceptionHandler.java` - 全局异常处理
- [x] `application.yml` - 事务配置参数

#### 2. 异常类
- [x] `BusinessException.java` - 业务异常
- [x] `DatabaseException.java` - 数据库异常

#### 3. Service层优化
已为以下关键方法添加事务注解：

**BmsFeeServiceImpl:**
- [x] charge() - 收费 (30秒超时)
- [x] refundCharge() - 退费 (30秒超时)
- [x] refundRegistrationCharge() - 挂号退费 (20秒超时)

**DmsDrugStoreServiceImpl:**
- [x] releaseDrug() - 发药 (20秒超时)
- [x] refundDrug() - 退药 (30秒超时)

**DmsRegistrationServiceImpl:**
- [x] createRegistration() - 创建挂号 (30秒超时)
- [x] appRegistration() - APP挂号 (30秒超时)

## 核心特性

### 1. 超时设置
- **默认超时**: 30秒
- **可自定义**: 根据业务复杂度调整
- **自动回滚**: 超时后自动回滚事务

### 2. 回滚策略
- **触发条件**: `rollbackFor = Exception.class`
- **覆盖范围**: 所有异常（包括检查型异常和运行时异常）
- **保证**: 数据一致性

### 3. 监控和日志
- **事务开始**: 记录方法名和开始时间
- **事务完成**: 记录执行时长
- **性能告警**: 超过5秒发出警告
- **事务回滚**: 记录详细异常信息

## 快速使用指南

### 步骤1: 在Service方法上添加注解

```java
@Transactional(timeout = 30, rollbackFor = Exception.class)
public int yourMethod() {
    // 业务逻辑
}
```

### 步骤2: 抛出异常触发回滚

```java
// 业务验证失败
if (invalid) {
    throw new BusinessException("错误码", "错误信息");
}

// 数据库操作失败
try {
    mapper.insert(record);
} catch (Exception e) {
    throw new DatabaseException("操作失败", e);
}
```

### 步骤3: 查看日志监控

```
INFO  - 事务开始 - 方法: YourService.yourMethod(..)
INFO  - 事务提交成功 - 方法: YourService.yourMethod(..), 耗时: 1234ms
```

## 推荐的超时时间配置

| 操作类型 | 推荐超时(秒) | 说明 |
|---------|------------|------|
| 简单查询 | 10-15 | 单表查询 |
| 单条插入/更新 | 15-20 | 基础CRUD |
| 复杂查询 | 20-30 | 多表关联 |
| 批量操作 | 30-60 | 小批量处理 |
| 大批量操作 | 60-120 | 大数据量处理 |

## 注意事项

### ⚠️ 必须遵守的规则

1. **不要捕获异常而不重新抛出**
   ```java
   // ❌ 错误
   try {
       operation();
   } catch (Exception e) {
       logger.error("失败", e);
       // 事务不会回滚！
   }
   
   // ✅ 正确
   try {
       operation();
   } catch (Exception e) {
       logger.error("失败", e);
       throw new DatabaseException("操作失败", e);
   }
   ```

2. **不要在事务中执行耗时的非数据库操作**
   ```java
   // ❌ 错误
   @Transactional
   public void wrongMethod() {
       dbOperation1();
       callExternalAPI(); // 外部API调用
       complexCalculation(); // 复杂计算
       dbOperation2();
   }
   
   // ✅ 正确
   public void correctMethod() {
       callExternalAPI();
       complexCalculation();
       executeDbTransaction();
   }
   ```

3. **合理设置超时时间**
   - 不要设置过长（浪费资源）
   - 不要设置过短（导致正常业务中断）
   - 根据实际测试结果调整

## 验证清单

### 开发阶段
- [ ] 所有涉及数据修改的Service方法都添加了@Transactional
- [ ] 超时时间设置合理
- [ ] 使用rollbackFor = Exception.class
- [ ] 异常处理正确（不吞掉异常）

### 测试阶段
- [ ] 测试正常提交场景
- [ ] 测试异常回滚场景
- [ ] 测试超时回滚场景
- [ ] 测试并发场景
- [ ] 验证日志输出正常

### 部署阶段
- [ ] 检查application.yml配置
- [ ] 验证数据库连接池配置
- [ ] 监控事务执行时间
- [ ] 设置告警阈值

## 故障排查

### 问题: 事务没有回滚
**检查项:**
1. 是否添加@Transactional注解
2. 异常是否被正确抛出
3. rollbackFor配置是否正确

### 问题: 事务超时
**检查项:**
1. 业务逻辑是否可以优化
2. 数据库查询是否需要优化
3. 是否有死锁
4. 超时配置是否合理

### 问题: 性能下降
**检查项:**
1. 事务范围是否过大
2. 是否在事务中执行非必要操作
3. 数据库索引是否合理
4. 是否有慢SQL

## 相关文档

- [事务管理配置文档.md](./事务管理配置文档.md) - 详细配置说明
- [TransactionExample.java](../HIS-master/HIS-common/src/main/java/com/neu/his/example/TransactionExample.java) - 代码示例

## 联系方式

如有问题，请联系开发团队。

---
最后更新: 2025-11-03
